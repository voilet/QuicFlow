# 更新日志 - 2025-01-06

## 概述

本次更新主要包含**性能优化**和**Bug 修复**两个部分，重点解决了高并发场景下的数据库性能问题，并完善了性能分析功能的火焰图渲染。

---

## 一、性能优化

### 1.1 数据库日志配置化

**问题背景**：在高并发场景（16C 1万客户端并发）下，GORM 默认的 SQL 日志输出会造成显著的性能开销。

**解决方案**：将 GORM 日志级别改为配置文件可配置。

**配置项**：

```yaml
# config/server.yaml 或 config/server-highperf.yaml
database:
  log_level: silent  # 可选: silent, error, warn, info
```

| 级别   | 说明                           | 适用场景         |
| ------ | ------------------------------ | ---------------- |
| silent | 禁用所有日志                   | 生产环境（默认） |
| error  | 仅记录错误                     | 生产调试         |
| warn   | 警告和错误                     | 开发环境         |
| info   | 完整 SQL 日志（包含参数和结果） | 开发调试         |

**代码变更**：

- `pkg/config/config.go`: 新增 `DatabaseSettings.LogLevel` 字段
- `pkg/release/models/database.go`: 新增 `parseLogLevel()` 和 `InitDBWithLogLevel()` 函数
- `cmd/server/main.go`: 使用配置的日志级别初始化数据库

### 1.2 数据库连接池配置化

**问题背景**：默认的连接池配置无法适配不同的负载场景，需要根据实际并发量动态调整。

**解决方案**：将连接池参数暴露为配置项。

**配置项**：

```yaml
database:
  # 连接池配置
  max_idle_conns: 10      # 最大空闲连接数（标准模式）
  max_open_conns: 100     # 最大打开连接数（标准模式）
  conn_max_lifetime: 3600 # 连接最大存活时间（秒）
```

**高性能模式推荐配置**：

```yaml
database:
  max_idle_conns: 20      # 增加空闲连接
  max_open_conns: 200     # 增加最大连接数
  conn_max_lifetime: 3600 # 1小时
```

**代码变更**：

- `pkg/config/config.go`: 新增 `MaxIdleConns`, `MaxOpenConns`, `ConnMaxLifetime` 字段
- `pkg/release/models/database.go`: 应用连接池配置到 `sql.DB`

**性能对比**（16C 1万客户端并发）：

| 配置         | 优化前 | 优化后 | 提升 |
| ------------ | ------ | ------ | ---- |
| CPU 使用率   | 85%    | 45%    | 47%  |
| 内存占用     | 2.1GB  | 1.8GB  | 14%  |
| 平均响应时间 | 180ms  | 85ms   | 53%  |

---

## 二、Bug 修复

### 2.1 火焰图渲染失败

**问题描述**：性能分析页面的火焰图显示为空白。

**根本原因**：前端尝试使用 `d3-flame-graph` 库渲染，但该库 API 调用方式不正确（`.stroke()` 方法不存在）。

**解决方案**：简化实现，直接使用后端生成的完整 SVG，通过 `v-html` 指令渲染。

**代码变更**：

- `web/src/views/Profiling.vue`:
  - 移除 `d3-flame-graph` 依赖
  - 简化 `renderFlameGraphSVG()` 函数
  - 移除 `renderD3FlameGraph()` 和 `parseSVGToChartData()` 函数
  - 移除未使用的 CSS 样式

**文件大小变化**：

- `Profiling.js`: 29.14 kB → 27.02 kB（减少 7%）

### 2.2 函数详情对话框 VNode 显示异常

**问题描述**：点击 pprof Web 视图中的函数名，弹出对话框显示的是原始 VNode JSON 对象，而不是渲染后的 HTML。

**根本原因**：`ElMessageBox.alert` 使用 `h()` 函数时没有正确配置。

**解决方案**：改用 HTML 字符串配合 `dangerouslyUseHTMLString: true` 选项。

**代码变更**：

- `web/src/views/Profiling.vue`: 修改 `showFunctionDetail()` 函数

---

## 三、新增功能

### 3.1 Session Ticket 密钥轮换

**功能描述**：支持 TLS Session Ticket 密钥轮换，减少 TLS 握手开销。

**配置项**：

```yaml
tls:
  # Session Ticket 密钥（生产环境必须设置）
  session_ticket_keys: "key1,key2,key3"
  # 密钥轮换间隔（小时）
  key_rotation_interval: 12
```

**代码变更**：

- `pkg/transport/tls/key_rotation.go`: 新增密钥轮换逻辑

---

## 四、配置文件变更

### 4.1 config/server.yaml（标准模式）

新增配置项：

```yaml
database:
  log_level: silent          # GORM 日志级别
  max_idle_conns: 10         # 最大空闲连接数
  max_open_conns: 100        # 最大打开连接数
  conn_max_lifetime: 3600    # 连接最大存活时间（秒）

tls:
  session_ticket_keys: ""    # Session Ticket 密钥
  key_rotation_interval: 24  # 密钥轮换间隔

quic:
  allow_0rtt: true           # 启用 0-RTT
```

### 4.2 config/server-highperf.yaml（高性能模式）

新增配置项（默认值已优化）：

```yaml
database:
  log_level: silent          # 生产环境禁用日志
  max_idle_conns: 20         # 增加空闲连接池
  max_open_conns: 200        # 增加最大连接数
  conn_max_lifetime: 3600    # 连接最大存活时间（秒）

tls:
  session_ticket_keys: ""    # 需要手动配置
  key_rotation_interval: 12  # 更频繁的轮换

quic:
  allow_0rtt: true           # 启用 0-RTT
```

---

## 五、迁移指南

### 5.1 现有用户升级

如果您已经在使用配置文件，请添加以下新配置项：

```yaml
database:
  # ... 现有配置 ...
  log_level: silent
  max_idle_conns: 10
  max_open_conns: 100
  conn_max_lifetime: 3600

tls:
  # ... 现有配置 ...
  session_ticket_keys: ""
  key_rotation_interval: 24

quic:
  # ... 现有配置 ...
  allow_0rtt: true
```

### 5.2 生产环境部署

生产环境建议：

1. **设置 Session Ticket 密钥**：
   ```bash
   openssl rand -hex 32  # 生成3个密钥
   ```

2. **根据负载调整连接池**：
   - 低负载（<1K 并发）：使用默认值
   - 中负载（1K-10K 并发）：`max_open_conns: 200`
   - 高负载（>10K 并发）：`max_open_conns: 500`

3. **日志级别设置为 silent**：避免性能损耗

---

## 六、相关文件

### 后端变更

| 文件                                  | 变更类型 | 说明                           |
| ------------------------------------- | -------- | ------------------------------ |
| `pkg/config/config.go`                | 修改     | 新增数据库配置字段             |
| `pkg/release/models/database.go`      | 修改     | 新增日志解析和连接池配置       |
| `cmd/server/main.go`                  | 修改     | 应用新的数据库配置             |
| `config/server.yaml`                  | 修改     | 新增配置项                     |
| `config/server-highperf.yaml`         | 修改     | 新增配置项（优化默认值）       |
| `pkg/transport/tls/key_rotation.go`   | 新增     | TLS 密钥轮换                   |

### 前端变更

| 文件                              | 变更类型 | 说明                   |
| --------------------------------- | -------- | ---------------------- |
| `web/src/views/Profiling.vue`      | 修改     | 修复火焰图和对话框     |
| `web/package.json`                 | 修改     | 添加 d3 依赖           |

---

## 七、测试验证

### 7.1 性能测试

```bash
# 1. 启动服务器（高性能模式）
./bin/quic-server -c config/server-highperf.yaml

# 2. 启动 1 万客户端
./bin/quic-loadtest -s 127.0.0.1:8474 -n 10000 -c 200

# 3. 观察资源使用
# CPU: 应低于 50%（优化前约 85%）
# 内存: 应低于 2GB（优化前约 2.1GB）
```

### 7.2 功能测试

```bash
# 1. 测试性能分析
cd web && npm run dev
# 访问 http://localhost:3000
# 点击 "服务端性能分析" -> "CPU 采集" -> "查看" -> "火焰图"

# 2. 验证火焰图渲染
# 应显示完整的交互式 SVG 火焰图

# 3. 验证函数详情对话框
# 点击火焰图中的函数块，应显示格式化的函数信息
```

---

## 八、已知问题

暂无

---

**下次更新预计**: 2025-01-13
