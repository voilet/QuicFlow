# QUIC-FLOW 发布管理系统 - 用户指南

## 目录

1. [凭证管理](#凭证管理)
2. [Webhook 自动部署](#webhook-自动部署)
3. [成员权限管理](#成员权限管理)

---

## 凭证管理

### 概述

凭证中心用于安全地存储和管理部署过程中所需的敏感信息，如 Git 仓库凭据、Docker 镜像仓库密码等。所有凭证使用 AES-256-GCM 加密存储。

### 支持的凭证类型

| 类型 | 说明 | 使用场景 |
|------|------|----------|
| Docker Registry | Docker 镜像仓库凭据 | 容器部署时拉取私有镜像 |
| Git SSH Key | Git SSH 私钥 | Git 拉取部署（SSH 方式） |
| Git Token | Git 访问令牌 | Git 拉取部署（HTTPS Token 方式） |
| 用户名密码 | 通用用户名密码 | Git 拉取部署（HTTPS 基础认证） |

### 创建凭证

1. 访问 **凭证中心** 页面
2. 点击 **新建凭证** 按钮
3. 填写凭证信息：
   - **名称**: 凭证的显示名称（如：GitHub 私有仓库）
   - **类型**: 选择凭证类型
   - **范围**:
     - 全局凭证：所有项目可用
     - 项目凭证：仅指定项目可用
   - **凭据信息**：根据类型填写对应字段
4. 点击 **保存**

### 使用凭证

在创建或编辑 Git 拉取类型的项目时：

1. 在 **Git 仓库配置** 区域找到 **使用凭证** 下拉框
2. 选择已保存的凭证
3. 系统会自动填充认证方式

### 凭证管理

- **编辑**：点击凭证操作列的编辑按钮，可修改凭证名称和描述
- **删除**：删除未被使用的凭证
- **查看**：点击凭证查看详情（敏感信息已脱敏）

---

## Webhook 自动部署

### 概述

Webhook 自动部署功能允许您在 Git 仓库代码推送时自动触发部署任务。支持 GitHub、GitLab 平台。

### 配置步骤

#### 1. 创建 Webhook

1. 在项目详情页，切换到 **Webhook 配置** 选项卡
2. 点击 **新建 Webhook**
3. 填写配置信息：
   - **名称**: Webhook 显示名称
   - **来源平台**: 选择 GitHub 或 GitLab
   - **分支过滤**: 设置触发部署的分支（如：main, develop）
   - **事件类型**: 选择触发事件（push, tag_create）
   - **动作**: 选择触发后执行的操作（部署）
   - **目标环境**: 选择部署目标环境
   - **自动部署**: 是否在触发后立即执行部署

#### 2. 配置 Git 仓库

##### GitHub

1. 复制系统生成的 **Webhook URL**
2. 复制系统生成的 **Secret**
3. 进入 GitHub 仓库设置 → Webhooks → Add webhook
4. 粘贴 Webhook URL
5. Content type 选择 `application/json`
6. Secret 粘贴到 Secret 字段
7. 选择触发事件（Push events）
8. 点击 **Add webhook**

##### GitLab

1. 复制系统生成的 **Webhook URL**
2. 复制系统生成的 **Secret**
3. 进入 GitLab 仓库设置 → Webhooks
4. 粘贴 Webhook URL
5. Secret token 粘贴到 Secret 字段
6. 选择触发事件（Push events）
7. 勾选 **Enable SSL verification**
8. 点击 **Add webhook**

#### 3. 测试 Webhook

- 在 Webhook 列表中点击 **测试** 按钮
- 系统会发送模拟推送事件
- 可在 **触发历史** 中查看测试结果

### 触发历史

查看 Webhook 触发记录：

1. 点击 Webhook 操作列的 **触发历史**
2. 查看每次触发的详细信息：
   - 触发时间
   - 触发分支/标签
   - 提交信息
   - 触发状态（成功/失败/跳过）
   - 关联的部署任务 ID

### 分支过滤

支持通配符匹配：

- `main`: 只匹配 main 分支
- `release/*`: 匹配所有 release/ 开头的分支
- `feature/*, hotfix/*`: 匹配多个分支模式

---

## 成员权限管理

### 概述

成员管理功能允许您控制用户对项目的访问和操作权限。

### 角色说明

| 角色 | 权限描述 |
|------|----------|
| **Owner** 所有者 | 完全控制权，可管理成员、修改配置、执行部署 |
| **Maintainer** 维护者 | 可配置项目、执行所有环境的部署 |
| **Developer** 开发者 | 仅可执行开发环境的部署 |
| **Viewer** 访客 | 只读权限，无法执行部署 |

### 添加成员

1. 在项目详情页，切换到 **成员管理** 选项卡
2. 点击 **添加成员**
3. 搜索用户（通过用户名或邮箱）
4. 选择角色
5. 点击 **保存**

### 管理成员

- **修改角色**: 点击成员操作列的编辑按钮，更改角色
- **移除成员**: 点击移除按钮，将成员从项目中移除
  - 注意：不能移除项目的最后一个所有者

### 成员统计

成员管理页面显示：

- 总成员数
- 各角色成员数量
- 最近添加的成员

---

## 快速导航

| 功能 | 路径 |
|------|------|
| 凭证中心 | 侧边栏 → 凭证中心 |
| 项目列表 | 发布管理 |
| Webhook 配置 | 项目详情 → Webhook 配置 |
| 成员管理 | 项目详情 → 成员管理 |
| 触发历史 | 侧边栏 → 触发历史 |

---

## 常见问题

### Q: 凭证信息安全吗？

A: 所有凭证使用 AES-256-GCM 加密算法加密存储，密钥由系统配置的 `QUIC_FLOW_SECRET_KEY` 生成。数据库中仅存储加密后的密文。

### Q: Webhook 触发后部署失败怎么办？

A: 在触发历史中查看错误信息，常见原因：
- 分支不匹配：检查分支过滤配置
- 凭证错误：确认 Git 凭证正确
- 环境不存在：确认目标环境已配置

### Q: 如何禁用某个 Webhook？

A: 编辑 Webhook，取消勾选 **启用** 状态，或在 Git 仓库中删除 Webhook 配置。

### Q: 成员角色如何影响部署操作？

A: 根据角色限制：
- Viewer: 无法创建部署任务
- Developer: 只能创建开发环境的部署任务
- Maintainer/Owner: 可创建所有环境的部署任务
