# 功能规范：QUIC 通信骨干网络

**功能分支**：`001-quic-backbone-network`
**创建日期**：2025-12-23
**状态**：草稿
**用户描述**：打造一个工业级、高性能且具备强一致性回调机制的 QUIC 通信骨干网络

## 用户场景与测试 *(必填)*

### 用户故事 1 - 建立可靠连接 (优先级: P1)

系统管理员需要部署一个通信服务器，客户端应用能够通过安全通道连接到服务器，并在连接建立后保持稳定的通信状态。即使在网络不稳定的情况下，客户端也应能自动重连并恢复通信。

**为什么这个优先级**：这是整个通信系统的基础。没有稳定可靠的连接，后续的消息传输、回调等功能都无法实现。这是最小可行产品（MVP）的核心。

**独立测试**：可以通过启动服务器和客户端，观察连接建立过程，断开网络后验证自动重连功能，完全测试连接管理的完整生命周期。

**验收场景**：

1. **假设** 服务器已启动并监听端口，**当** 客户端发起连接请求，**则** 连接在正常网络环境下 100ms 内成功建立
2. **假设** 客户端已连接到服务器，**当** 网络中断 5 秒后恢复，**则** 客户端自动重连并在 60 秒内恢复通信
3. **假设** 客户端尝试连接服务器，**当** 连接失败，**则** 客户端按照指数退避策略自动重试（间隔依次为 1s、2s、4s、8s... 最大 60s）
4. **假设** 连接已建立，**当** 客户端状态从 Idle 转为 Connecting 再到 Connected，**则** 每个状态转换都能被监控系统捕获并记录

---

### 用户故事 2 - 消息可靠传输 (优先级: P1)

业务应用需要通过通信网络向一个或多个客户端发送指令消息。系统必须保证消息能够准确送达目标客户端，即使在弱网环境下也不能丢失。对于重要指令，发送方需要得到执行结果的反馈。

**为什么这个优先级**：消息传输是通信网络的核心价值。没有可靠的消息传输，整个系统就失去了存在的意义。与连接管理同为 P1 优先级。

**独立测试**：可以通过发送单播和广播消息，在正常网络和模拟弱网环境（丢包、延迟）下验证消息送达率，测试带回调的消息是否能正确返回执行结果。

**验收场景**：

1. **假设** 服务器有 5 个已连接的客户端，**当** 服务器广播一条消息，**则** 所有 5 个客户端都能收到该消息
2. **假设** 服务器需要向特定客户端发送指令，**当** 执行 SendTo(ClientID, payload)，**则** 只有指定的客户端收到消息
3. **假设** 服务器发送一条需要确认的消息（WaitAck: true），**当** 客户端收到并处理完成，**则** 服务器在超时时间内收到执行结果的回调
4. **假设** 网络丢包率达到 20%，**当** 发送 100 条消息，**则** 通过 QUIC 层重传机制，所有消息最终都能送达（送达率 100%）
5. **假设** 客户端处理消息超时，**当** 服务器等待回调超过预设时间，**则** 服务器收到超时通知并可采取后续措施

---

### 用户故事 3 - 连接健康监控 (优先级: P2)

运维人员需要实时了解所有客户端的连接状态和健康情况。系统应自动检测客户端是否在线，对于长时间无响应的客户端应自动清理，释放资源。

**为什么这个优先级**：健康监控是生产环境必需的功能，但不阻塞基本的消息传输能力。可以在完成 P1 功能后独立实现和部署。

**独立测试**：可以通过启动多个客户端，模拟部分客户端停止响应心跳，验证服务器能否正确检测并清理这些无效连接，同时不影响正常客户端的通信。

**验收场景**：

1. **假设** 客户端已连接到服务器，**当** 客户端每 15 秒发送一次心跳 Ping，**则** 服务器响应 Pong 并更新该客户端的最后活跃时间
2. **假设** 服务器监控到某客户端，**当** 连续 3 次心跳周期（45 秒）未收到该客户端的心跳，**则** 服务器强制关闭该连接并从会话列表中移除
3. **假设** 系统运行中，**当** 查询当前连接列表，**则** 可以获得每个客户端的 ID、连接时长、最后心跳时间等状态信息
4. **假设** 客户端因崩溃而无法发送心跳，**当** 超时后服务器清理该连接，**则** 不影响其他客户端的正常通信

---

### 边界情况

- **高并发场景**：当服务器同时维护 10,000 个客户端连接时，系统如何保证消息分发的性能和资源使用的合理性？
- **消息积压**：当客户端离线或处理缓慢导致消息队列积压时，系统如何处理？是否有限流或拒绝策略？
- **回调超时**：当大量消息等待回调超时时，内存中的 Promise Map 如何避免无限增长导致内存溢出？
- **客户端身份验证失败**：当客户端 TLS 证书无效或验证失败时，连接应立即拒绝还是允许有限重试？
- **服务器重启**：当服务器重启时，客户端如何感知并重连？是否需要恢复之前的会话状态？
- **消息顺序性**：在 QUIC 多流传输下，如何保证同一客户端的消息按发送顺序到达？是否需要顺序保证？
- **网络分区**：当出现网络分区导致部分客户端无法连接时，系统如何处理？

## 需求 *(必填)*

### 功能需求

#### 连接管理

- **FR-001**：系统必须支持客户端通过 QUIC 协议连接到服务器
- **FR-002**：系统必须支持安全连接，使用 TLS 1.3 进行加密和身份验证
- **FR-003**：客户端必须实现三状态连接模型：Idle（空闲）→ Connecting（连接中）→ Connected（已连接）
- **FR-004**：客户端必须在连接失败或断开后自动重连，重试间隔按指数退避策略增长（1s, 2s, 4s, 8s... 最大 60s）
- **FR-005**：系统必须支持单个服务器实例维护至少 10,000 个并发客户端连接

#### 心跳机制

- **FR-006**：客户端必须每 15 秒向服务器发送一次心跳 Ping 帧
- **FR-007**：服务器必须在收到 Ping 后立即响应 Pong
- **FR-008**：服务器必须监控每个客户端的心跳状态，连续 3 次心跳周期（45 秒）未收到心跳时，强制关闭该客户端连接并移除会话
- **FR-009**：心跳机制必须独立于业务消息处理，不干扰正常的消息传输

#### 消息传输

- **FR-010**：系统必须支持服务器向单个客户端发送消息（单播）
- **FR-011**：系统必须支持服务器向所有已连接客户端发送消息（广播）
- **FR-012**：系统必须使用序列化协议对消息进行编码和解码
- **FR-013**：系统必须在弱网环境（丢包率 ≤ 20%）下保证消息的可靠送达，通过 QUIC 层的重传机制实现
- **FR-014**：系统必须为每条消息分配唯一的消息 ID（MsgID）

#### 异步回调

- **FR-015**：消息必须支持"需要确认"标记（WaitAck 字段），指示该消息需要客户端返回执行结果
- **FR-016**：服务器必须为标记需要确认的消息维护一个等待映射表（MsgID → Response Channel）
- **FR-017**：客户端必须在处理完需要确认的消息后，返回执行结果给服务器
- **FR-018**：服务器必须支持为等待回调的消息设置超时时间，超时后触发超时处理逻辑
- **FR-019**：系统必须在收到回调或超时后，清理等待映射表中对应的条目，避免内存泄漏

#### 状态监控

- **FR-020**：系统必须提供连接状态查询接口，能够列出所有当前已连接的客户端
- **FR-021**：系统必须记录每个客户端的关键信息：客户端 ID、连接时间、最后心跳时间
- **FR-022**：系统必须提供连接状态变化的事件钩子，供业务层订阅（连接建立、断开、超时等）
- **FR-023**：系统必须记录关键操作的日志，包括连接建立/断开、消息发送/接收、心跳超时、重连尝试等

### 关键实体

- **客户端会话（ClientSession）**：代表一个已连接的客户端，包含客户端 ID、连接对象、最后活跃时间、状态（空闲/连接中/已连接）
- **消息（Message）**：代表一条通信消息，包含消息 ID、发送方、接收方、消息内容（payload）、是否需要确认（WaitAck）、时间戳
- **回调记录（CallbackRecord）**：代表一个等待中的回调，包含消息 ID、响应通道（channel）、超时时间、创建时间
- **心跳记录（HeartbeatRecord）**：代表客户端的心跳状态，包含客户端 ID、最后心跳时间、连续超时次数

## 成功标准 *(必填)*

### 可衡量的成果

#### 性能指标

- **SC-001**：在正常网络环境下，客户端到服务器的连接建立时间小于 100ms
- **SC-002**：单个连接的消息传输延迟（P99）：局域网 < 50ms，广域网 < 200ms
- **SC-003**：单连接消息吞吐量达到 10,000 条/秒以上
- **SC-004**：单服务器实例支持 10,000 个并发客户端连接，CPU 使用率 < 80%，内存使用 < 8GB

#### 可靠性指标

- **SC-005**：在网络丢包率 20% 的弱网环境下，消息最终送达率达到 100%（通过重传）
- **SC-006**：客户端断线后，能够在 60 秒内完成自动重连（假设网络已恢复）
- **SC-007**：服务器重启后，90% 的客户端能在 2 分钟内重新建立连接
- **SC-008**：需要确认的消息，95% 能在 5 秒内收到客户端的执行结果回调

#### 监控与运维指标

- **SC-009**：心跳超时的客户端能在 45 秒内被自动检测并清理
- **SC-010**：系统能够实时提供当前连接数、消息吞吐量、平均延迟等关键指标
- **SC-011**：所有连接状态变化（建立、断开、超时）都能被事件钩子捕获并记录到日志
- **SC-012**：运维人员能通过监控界面或 API 查询任意客户端的连接状态和历史记录

#### 业务价值指标

- **SC-013**：业务应用能够通过简单的 API 调用（不超过 5 行代码）实现消息发送和回调处理
- **SC-014**：系统在生产环境运行 30 天内，因通信故障导致的业务中断时间 < 1 小时（99.86% 可用性）

## 假设与约束

### 假设

1. 客户端和服务器运行在支持 QUIC 协议的网络环境中
2. 客户端和服务器的时钟基本同步（时间差 < 5 分钟）
3. 消息内容（payload）的大小通常小于 64KB，极端情况不超过 1MB
4. 业务层能够容忍最多 60 秒的消息延迟（在极端弱网和重连场景下）
5. 客户端 ID 在系统中唯一，由业务层生成并保证不重复

### 约束

1. 必须使用 QUIC 协议作为传输层，不支持降级到 TCP
2. 必须使用 TLS 1.3 进行加密，不支持更低版本的 TLS
3. 消息序列化格式在本规范中未指定具体技术，但要求支持跨平台和高压缩比
4. 单条消息的处理时间由业务层决定，通信层不限制，但回调超时时间可配置
5. 服务器为单实例部署，不在本期需求中考虑多实例负载均衡和高可用架构

## 超出范围

以下功能明确不在本次需求范围内：

1. **消息持久化**：消息不会存储到数据库，仅在内存中传输
2. **消息队列**：不提供消息队列功能，客户端离线期间的消息会丢失
3. **用户认证与鉴权**：仅支持 TLS 证书验证，不提供应用层的用户登录、权限管理
4. **消息加密**：依赖 TLS 1.3 提供的传输加密，不提供额外的端到端加密
5. **集群部署**：不支持多服务器实例的负载均衡、故障转移、状态同步
6. **Web 管理界面**：不提供图形化的管理和监控界面，仅提供 API 和日志
7. **消息优先级**：所有消息按到达顺序处理，不支持优先级队列
8. **流量控制**：不提供应用层的流量控制和限流机制（依赖 QUIC 的流控）
